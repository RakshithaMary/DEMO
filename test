WITH [(i IN range(0,2) |
        substring(date() - duration({months: i}), 0, 7)
     )] AS validMonths

MATCH (agg:AggTx)
MATCH (agg)-[:FOR_CLIENT]->(c:Client)
MATCH (agg)-[:FOR_DEPOSIT_PRODUCT]->(dp:DepositProduct)
MATCH (agg)-[:FOR_FLOW]->(f:Flow)
MATCH (agg)-[:FOR_CHANNEL]->(ch:Channel)
MATCH (agg)-[:FOR_PAYMENT_PRODUCT]->(pp:PaymentProduct)
MATCH (agg)-[:FOR_FI]->(fi:FinancialInstitution)
MATCH (agg)-[:FOR_PROSPECT]->(p:Prospect)
WHERE agg.monthId IN validMonths

WITH agg, c, dp, f, ch, pp, fi, p,

[
    {
        level: 'Client',
        levelKey: c.clientId,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    },
    {
        level: 'DepositProduct',
        levelKey: c.clientId + '|' + dp.name,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    },
    {
        level: 'Flow',
        levelKey: c.clientId + '|' + dp.name + '|' + f.direction,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    },
    {
        level: 'Channel',
        levelKey: c.clientId + '|' + dp.name + '|' + f.direction + '|' + ch.name,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    },
    {
        level: 'PaymentProduct',
        levelKey: c.clientId + '|' + dp.name + '|' + f.direction + '|' + ch.name + '|' + pp.name,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    },
    {
        level: 'FinancialInstitution',
        levelKey: c.clientId + '|' + dp.name + '|' + f.direction + '|' + ch.name + '|' + pp.name + '|' + fi.name,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    },
    {
        level: 'Prospect',
        levelKey: c.clientId + '|' + dp.name + '|' + f.direction + '|' + ch.name + '|' + pp.name + '|' + fi.name + '|' + p.name,
        totalAmount: agg.totalAmount,
        txCount: agg.txCount
    }
] AS rows

UNWIND rows AS r

RETURN 
    r.level,
    r.levelKey,
    sum(r.totalAmount) AS totalAmount,
    sum(r.txCount) AS txCount,
    count(*) AS combinations
ORDER BY r.level;
