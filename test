neo4j_query = """
UNWIND $data AS item

// determine flow
WITH item,
     CASE WHEN item.payor_or_payee = 'PAYOR' THEN 'Sent' ELSE 'Received' END AS flowDir

// match all dimension nodes (they already exist)
MATCH (c:Client {clientId: item.client_id})
MATCH (dp:DepositProduct {name: item.dep_product})
MATCH (f:Flow {direction: flowDir})
MATCH (ch:Channel {name: item.channel})
MATCH (pp:PaymentProduct {name: item.payment_product})
MATCH (fi:FinancialInstitution {name: item.fi_name})
MATCH (p:Prospect {prospectId: item.prospect_id})

// create one aggregated transaction node
CREATE (agg:AggTxn {
    totalAmount: item.total_amount,
    txCount: item.total_volume,
    monthId: item.month_id
})

// create relationships
MERGE (agg)-[:FOR_CLIENT]->(c)
MERGE (agg)-[:FOR_DEPOSIT_PRODUCT]->(dp)
MERGE (agg)-[:FOR_FLOW]->(f)
MERGE (agg)-[:FOR_CHANNEL]->(ch)
MERGE (agg)-[:FOR_PAYMENT_PRODUCT]->(pp)
MERGE (agg)-[:FOR_FI]->(fi)
MERGE (agg)-[:FOR_PROSPECT]->(p)
"""
